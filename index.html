<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AutoRefresh Extension</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <!-- Countdown plugin: try CDN, fallback to local -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.countdown360/1.2.3/jquery.countdown360.min.js"></script>
  <script>
    if (typeof jQuery.fn.countdown360 === "undefined") {
      document.write('<script src="jquery.countdown360.min.js"><\/script>');
    }
  </script>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f9fafb;
      color: #444;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    #configPanel {
      background: white; 
      border: 1px solid #ccd0d5; 
      padding: 20px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 6px;
      max-width: 320px;
      text-align: center;
    }
    #mainUI {
      display: none;
      text-align: center;
    }
    #countdown {
      margin: 20px auto;
      width: 140px;
      height: 140px;
    }
    select, button {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 16px;
    }
    #nextRefresh, #lastRefresh, #datasourceInfo {
      margin-top: 12px;
      font-weight: bold;
      color: #2e7d32;
    }
  </style>
</head>
<body>

  <div id="configPanel">
    <h3>Select Options</h3>
    <label for="datasourceSelect">Datasource:</label>
    <br />
    <select id="datasourceSelect"></select>
    <br />
    <label for="intervalSelect">Refresh interval:</label>
    <br />
    <select id="intervalSelect">
      <option value="2">2 seconds</option>
      <option value="5" selected>5 seconds</option>
      <option value="10">10 seconds</option>
      <option value="30">30 seconds</option>
      <option value="60">1 minute</option>
    </select>
    <br />
    <button id="startButton">Start Refresh Timer</button>
  </div>

  <div id="mainUI">
    <div id="datasourceInfo"></div>
    <div id="countdown"></div>
    <div id="nextRefresh">Next refresh at:</div>
    <div id="lastRefresh">Last refreshed at:</div>
  </div>

<script>
  let countdown, refreshInterval, timerActive = true;
  let selectedDatasource = null;

  function formatTime(date) {
    return date.toLocaleTimeString();
  }

  function updateNextRefresh() {
    const now = new Date();
    const next = new Date(now.getTime() + refreshInterval * 1000);
    $("#nextRefresh").text("Next refresh at: " + formatTime(next));
  }

  function updateLastRefresh() {
    const now = new Date();
    $("#lastRefresh").text("Last refreshed at: " + formatTime(now));
  }

  function refreshData() {
    if (!selectedDatasource) return;
    selectedDatasource.refreshDataAsync().then(() => {
      updateLastRefresh();
      updateNextRefresh();
    }).catch(() => {
      updateNextRefresh();
    });
  }

  function initCountdown() {
    if ($("#countdown canvas").length) $("#countdown").empty();

    countdown = $("#countdown").countdown360({
      radius: 60,
      seconds: refreshInterval,
      strokeStyle: "#2e7d32",
      fillStyle: "#cfe9ff",
      fontColor: "#2e7d32",
      autostart: true,
      smooth: true,
      onComplete: () => {
        if (timerActive) {
          refreshData();
          countdown.start();
        }
      }
    }).start();

    $("#countdown").off("click").on("click", () => {
      if (countdown.isActive()) {
        countdown.pause();
        timerActive = false;
      } else {
        countdown.start();
        timerActive = true;
      }
    });
  }

  function populateDatasources() {
    const dashboard = tableau.extensions.dashboardContent.dashboard;
    dashboard.getDataSourcesAsync().then(datasources => {
      const $dsSelect = $("#datasourceSelect");
      $dsSelect.empty();
      datasources.forEach(ds => {
        $dsSelect.append(new Option(ds.name, ds.id));
      });
      if (datasources.length > 0) {
        selectedDatasource = datasources[0];
      }
    });
  }

  $("#startButton").on("click", () => {
    const dsId = $("#datasourceSelect").val();
    tableau.extensions.dashboardContent.dashboard.getDataSourcesAsync().then(dashboardDatasources => {
      selectedDatasource = dashboardDatasources.find(ds => ds.id === dsId);
      refreshInterval = parseInt($("#intervalSelect").val(), 10);

      // Show main UI
      $("#configPanel").hide();
      $("#mainUI").show();

      updateNextRefresh();
      updateLastRefresh();
      populateSelectedDatasourceInfo();
      initCountdown();
    });
  });

  function populateSelectedDatasourceInfo() {
    if(selectedDatasource){
      $("#datasourceInfo").text("Datasource: " + selectedDatasource.name);
    }
  }

  // Initialize with menu handlers
  tableau.extensions.initializeAsync(
    {
      // Config menu handler
      'configure': () => {
        $("#mainUI").hide();
        $("#configPanel").show();
      }
    },
    {
      // Context menu handler
      'refreshNow': () => {
        refreshData();
      }
    }
  ).then(() => {
    populateDatasources();
  });

</script>
</body>
</html>
